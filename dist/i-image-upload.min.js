/*!
 * i-image-upload v1.0.1
 * Based on ImageUploader (c) Ross Turner (https://github.com/CN-kicoyu/i-image-upload)
 * Adapted by (c) 2018 kicoyu
 * Released under the MIT License.
 */


!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("exif-js"),require("blueimp-canvas-to-blob")):"function"==typeof define&&define.amd?define(["exports","exif-js","blueimp-canvas-to-blob"],e):e(t.IImageUpload=t.IImageUpload||{},t.EXIF,t.dataURLtoBlob)}(this,function(t,o,r){"use strict";function i(e){if("undefined"!=typeof XMLHttpRequest){var t=new XMLHttpRequest,a=e.action;t.upload&&(t.upload.onprogress=function(t){0<t.total&&(t.percent=t.loaded/t.total*100),e.onProgress(t)});var n=new FormData;return n.append(e.filename,e.file,e.file.name),t.onerror=function(t){e.onError(t)},t.onload=function(){if(t.status<200||300<=t.status)return e.onError(function(t,e){var a;a=e.response?""+(e.response.error||e.response):e.responseText?""+e.responseText:"fail to post "+t+" "+e.status;var n=new Error(a);return n.status=e.status,n.method="post",n.url=t,n}(a,t));e.onSuccess(function(t){var e=t.responseText||t.response;if(!e)return e;try{return JSON.parse(e)}catch(t){return e}}(t))},t.open("post",a,!0),t.send(n),t}}o="default"in o?o.default:o,r="default"in r?r.default:r;var e={type:Function,default:function(){}},a={render:function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("div",{staticClass:"y-upload"},[t._t("default"),t._v(" "),a("input",{ref:t.name,staticClass:"y-input",attrs:{type:"file",name:t.name,accept:"image/*",capture:t.capture,disabled:t.disabled},on:{change:t.onChange}})],2)},staticRenderFns:[],_scopeId:"data-v-86fbcba0",name:"i-image-upload",props:{name:{type:String,default:"file"},disabled:{type:Boolean,default:!1},beforeUpload:Function,onPreview:Object.assign({},e),onProgress:Object.assign({},e),onSuccess:Object.assign({},e),onError:Object.assign({},e),customHandleUpload:Function,maxWidth:{type:Number,default:1024},maxHeight:{type:Number,default:1024},autoScale:{type:Boolean,default:!0},quality:{type:Number,default:1},scaleRatio:Number,autoRotate:{type:Boolean,default:!0},resultType:{type:String,default:"base64"},action:String,capture:String},methods:{onChange:function(t){var n=this,e=t.target.files&&t.target.files.length?t.target.files[0]:null;this.disabled||!e||this.beforeUpload&&!this.beforeUpload(e)||(this.currentFile=e,this.readFile(e).then(function(t){var e=t.content,a=t.rotate;n.onHandleUpload(e,a)}))},readFile:function(n){var i=this;return new Promise(function(e){var a=document.createElement("img"),t=new window.FileReader;t.onload=function(t){a.src=t.target.result,a.onload=function(){i.autoRotate&&void 0!==o&&"function"==typeof o.getData&&"function"==typeof o.getTag?o.getData(a,function(){var t=o.getTag(this,"Orientation");e({content:a,rotate:t})}):e({content:a,rotate:void 0})}},t.readAsDataURL(n)})},onHandleUpload:function(t,e){var a=this,n=document.createElement("canvas");n.width=t.width,n.height=t.height;var i=n.getContext("2d");i.save();var o=n.width,r=n.style.width,s=n.height,d=n.style.height;if(void 0===e&&(e=1),e)switch(4<e&&(n.width=s,n.style.width=d,n.height=o,n.style.height=r),e){case 2:i.translate(o,0),i.scale(-1,1);break;case 3:i.translate(o,s),i.rotate(Math.PI);break;case 4:i.translate(0,s),i.scale(1,-1);break;case 5:i.rotate(.5*Math.PI),i.scale(1,-1);break;case 6:i.rotate(.5*Math.PI),i.translate(0,-s);break;case 7:i.rotate(.5*Math.PI),i.translate(o,-s),i.scale(-1,1);break;case 8:i.rotate(-.5*Math.PI),i.translate(-o,0)}i.drawImage(t,0,0),i.restore();var l=n.width/n.height,u=this.autoScale?Math.min(this.maxWidth,l*this.maxHeight):l*this.maxHeight;for(this.scaleRatio&&(u=Math.min(u,Math.floor(this.scaleRatio*n.width))),u<=0&&(u=1);n.width>=2*u;)n=a.getHalfScaleCanvas(n);n.width>u&&(n=this.getAlgorithmCanvas(n,u));var h="image/jpeg"===this.currentFile.type?this.quality:1,c=n.toDataURL(this.currentFile.type,h),f=this.formatResultType(c);if(this.onPreview(f),!this.customHandleUpload){if(!this.action)return;return this.uploadImage(c)}var p=this.customHandleUpload(f,{width:n.width,height:n.height});p&&p.then&&p.then(function(t){a.$refs[a.name]&&(a.$refs[a.name].value=""),a.onSuccess(t,c)},function(t){a.$refs[a.name]&&(a.$refs[a.name].value=""),a.onError(t,c)})},uploadImage:function(e){var a=this,n=this.formatResultType(e);i({file:this.dataURLtoFile(e),filename:this.name,action:this.action,onProgress:function(t){a.onProgress(t,e)},onSuccess:function(t){a.$refs[a.name]&&(a.$refs[a.name].value=""),a.onSuccess(t,n)},onError:function(t){a.$refs[a.name]&&(a.$refs[a.name].value=""),a.onError(t,n)}})},getHalfScaleCanvas:function(t){var e=document.createElement("canvas");return e.width=t.width/2,e.height=t.height/2,e.getContext("2d").drawImage(t,0,0,e.width,e.height),e},getAlgorithmCanvas:function(t,e){var a=document.createElement("canvas"),n=e/t.width;a.width=t.width*n,a.height=t.height*n;var i=t.getContext("2d").getImageData(0,0,t.width,t.height),o=a.getContext("2d").createImageData(a.width,a.height);return this.bilinearInterpolation(i,o,n),a.getContext("2d").putImageData(o,0,0),a},bilinearInterpolation:function(t,e,a){function n(t,e,a,n,i,o){var r=1-i,s=1-o;return t*r*s+e*i*s+a*r*o+n*i*o}for(var i,o,r,s,d,l,u,h,c,f,p,g,m,v,w,b,y,I=0;I<e.height;++I){i=I/a,o=Math.floor(i),r=Math.ceil(i)>t.height-1?t.height-1:Math.ceil(i);for(var x=0;x<e.width;++x)s=x/a,d=Math.floor(s),l=Math.ceil(s)>t.width-1?t.width-1:Math.ceil(s),u=4*(x+e.width*I),h=4*(d+t.width*o),c=4*(l+t.width*o),f=4*(d+t.width*r),p=4*(l+t.width*r),g=s-d,m=i-o,v=n(t.data[h],t.data[c],t.data[f],t.data[p],g,m),e.data[u]=v,w=n(t.data[h+1],t.data[c+1],t.data[f+1],t.data[p+1],g,m),e.data[u+1]=w,b=n(t.data[h+2],t.data[c+2],t.data[f+2],t.data[p+2],g,m),e.data[u+2]=b,y=n(t.data[h+3],t.data[c+3],t.data[f+3],t.data[p+3],g,m),e.data[u+3]=y}},dataURLtoFile:function(t){var e=this.currentFile,a=e.name,n=e.type,i=Object.prototype.toString.call(t),o=t;return"[object File]"!==i?(o="[object Blob]"===i?t:r(t),new window.File([r(t)],a,{type:n})):o},formatResultType:function(t){return"blob"===this.resultType&&void 0!==r?r(t):t}}};var n={install:function t(e){t.installed||(t.installed=!0,e.component("i-image-upload",a))},IImageUpload:a};void 0!==typeof window&&window.Vue&&window.Vue.use(n),t.default=n,Object.defineProperty(t,"__esModule",{value:!0})});